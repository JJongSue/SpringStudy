## 6.5.4 AOP란 무엇인가?

### 트랜잭션 서비스 추상화
* 트랜잭션 경계설정 코드속에 비즈니스 로직을 담은 코드를 넣으면 특정 트랜잭션 기술에 종속된다는 문제가 있었다.
  * 스프링이 제공하는 PlatformTransactionManager를 이용한 추상화 기법으로 해결할 수 있었다.

### 프록시와 데코레이터 패턴
* 트랜잭션을 어떻게 다룰 것인지는 추상화를 통해 해결했어도 여전히 비즈니스 로직 코드에는 트랜잭션을 사용하는 코드가 드러나있다. 
* 대부분의 비즈니스 로직에 트랜잭션이 필요하므로 트랜잭션의 경계를 설정하는 코드가 비즈니스 로직을 처리하는 메소드에 반복적으로 등장한다.
  * DI를 이용한 데코레이터 패턴을 이용해서 비즈니스 로직과 트랜잭션 코드를 완전히 분리시킬 수 있었다.
  * UserServiceTx에서 트랜잭션 코드 적용 --> UserServiceImpl의 메소드 호출 --> UserServiceTx 트랜잭션 종료

### 다이내믹 프록시와 프록시 팩토리 빈
* 하지만 비즈니스 로직 메소드마다 UserServiceTx와 같은 프록시 클래스를 만드는 작업은 번거롭다. 또, 트랜잭션 기능을 제공하는 코드가 여러 메소드에 중복돼서 나타날 것이다. 
  * 스프링의 프록시 팩토리 빈을 이용해 어드바이스와 포인트컷을 분리함으로써 여러 프록시에서 어드바이스와 포인트컷을 공유해서 사용할 수 있었다.  

### 자동 프록시 생성 방법과 포인트컷
* 빈 후처리기를 이용해 컨테이너 초기화 시점에 포인트컷으로 적용 대상을 선정한 뒤 자동으로 프록시를 만들어주는 방법을 도입했다. 

### 부가기능의 모듈화
* 부가기능은 핵심기능과 같은 방식으로는 모듈화하기 힘들다. 
  * 애플리케이션 전반에 흩어져있고, 스스로 독립적인 방식으로 존재해서는 적용되기 어렵기 때문이다. 
* 부가기능인 트랜잭션 경계설정 기능은 어드바이스와 포인트컷을 결합한 어드바이저를 통해 독립적으로 모듈화 할 수 있었다.

### AOP: 애스펙트 지향 프로그래밍
* 부가기능 모듈을 애스펙트(aspect)라고 한다.
* 어드바이저(어드바이스 + 포인트컷)는 아주 단순한 형태의 애스펙트라고 할 수 있다.
* 애플리케이션의 핵심적인 기능에서 부가적인 기능을 분리해 애스펙트라는 독특한 모듈로 설계하고 개발하는 방법을 애스펙트 지향 프로그래밍(Aspect Oriented Programming, AOP)라고 부른다.
* AOP는 애스펙트를 분리함으로써 핵심 기능을 설계할 때 객체지향적인 가치를 지킬 수 있도록 도와준다.

## 6.5.5 AOP 적용 기술
### 프록시를 이용한 AOP
* 스프링 AOP의 부가기능은 오브젝트의 메소드를 대상으로 적용된다.
* 프록시 방식을 사용하므로 프록시로부터 메소드 요청정보를 전달받아서 타깃 오브젝트의 메소드를 호출한다. 
* 타깃 오브젝트의 메소드를 호출하는 전후에 다양한 부가기능을 제공할 수 있다. 즉, 메소드 호출 과정에 참여해서 부가기능을 제공한다. 

### 바이트코드 생성과 조작을 통한 AOP
* AOP 프레임워크인 AspectJ는 바이트코드를 조작하는 방식으로 AOP 기술을 적용한다.
* 컴파일된 타깃의 클래스 파일을 수정하거나 클래스가 JVM에 로딩되는 시점에 바이트코드를 조작한다.

* AspectJ의 장점
  1. 바이트코드를 조작해 타깃 오브젝트를 직접 수정하면 DI 컨테이너의 도움 없이도 AOP를 적용할 수 있다.
  2. 프록시 방식보다 훨씬 유연하고 강력하다.
    - 프록시를 사용하는 방식은 부가기능의 대상을 클라이언트가 호출하는 메소드로 제한된다.
    - 바이트코드를 조작하면 오브젝트 생성, 필드 값 조작, 스태틱 초기화 등 다양한 작업에 부가기능을 부여할 수 있다.

* 단, AspectJ는 JVM 실행 옵션을 변경하거나, 별도의 컴파일러와 클래스 로더를 사용하는 등의 번거로우 작업이 필요하다. 일반적인 AOP 적용은 프록시 방식의 스프링 AOP로 충분하다.

## 6.5.6 AOP의 용어
- **`타깃(Target)`** : 부가기능을 부여할 대상.  
- **`어드바이스(Advice)`** : 타깃에 적용할 부가기능을 담은 모듈
- **`조인 포인트(JoinPoint)`** : 어드바이스가 적용될 수 있는 위치. 스프링의 AOP에서는 메소드의 실행단계
- **`포인트컷(PointCut)`** : 부가기능이 적용될 대상(메서드)를 선정
- **`프록시(Proxy)`** : 클라이언트와 타깃 사이에 존재하면서 부가기능을 제공하는 오브젝트
- **`어드바이저(Advisor)`** : 어드바이스 + 포인트컷
- **`애스펙트(Aspect)`** : AOP의 기본 모듈

## 6.5.7 AOP 네임스페이스

### AOP 네임스페이스
* 스프링 AOP를 적용하기 위해서는 최소한 다음 4개의 빈을 등록해야 한다.
1. 자동 프록시 생성기 : DefaultAdvisorAutoProxyCreator 클래스를 빈으로 등록한다.
2. 어드바이스 : 부가기능을 구현한 클래스를 빈으로 등록한다. 
3. 포인트컷: 스프링의 AspectJExpressionPointcu을 빈으로 등록하고 expression 프로퍼티에 포인트컷 표현식을 넣어주면 된다.
4. 어드바이저 : DefaultPointcutAdvisor 클래스를 빈으로 등록해서 사용한다.  자동프록시 생성기에 의해 자동 검색되어 사용된다.

* 스프링은 AOP를 위해 기계적으로 적용하는 빈들을 간편한 방법으로 등록할 수 있다. AOP와 관련된 태그를 정의한 aop 스키마를 제공하기 때문이다.



``` build.gradle
implementation 'org.springframework.boot:spring-boot-starter-aop' 
``` 

* build.gradle에 위의 의존성을 추가하면 AnnotationAwareAspectJAutoProxyCreator라는 자동 프록시 생성기가 빈으로 등록된다.
![image](https://user-images.githubusercontent.com/81108344/185739347-cf2b6325-0bed-4faf-a631-3cd1c3d459c9.png)

* 어드바이스, 포인트컷, 어드바이저의 설정은 아래와 같다.
![image](https://user-images.githubusercontent.com/81108344/185739453-2fff8b8d-e8ee-4d46-b8ce-58fd44a154db.png)

* 실행 결과
![image](https://user-images.githubusercontent.com/81108344/185739484-ddfd7d3c-5f51-47eb-9e1f-94aa3b7d5440.png)
